#!/usr/bin/env bash

export MISE_NODE_COREPACK=1
export MISE_NODE_DEFAULT_PACKAGES_FILE="$PWD/.default-npm-packages"
export NPM_CONFIG_FUND=false
export MISE_LOCKFILE=1
export MISE_EXPERIMENTAL=1

latest=$(mise latest node)
echo "v$latest" >.node-version
echo "zx" >"$MISE_NODE_DEFAULT_PACKAGES_FILE"

mise i node@lts/hydrogen
mise i -f node
assert_contains "mise x node@lts/hydrogen -- node --version" "v18."
assert "mise x -- node --version" "v$latest"
assert_contains "mise x -- which yarn" "yarn"
assert_contains "mise x -- which zx" "zx"

mise use nodejs@20.1.0
mise ls
assert "mise x -- node --version" "v20.1.0"
assert_contains "mise ls-remote nodejs" "20.1.0"

echo "=== Testing multi-platform lockfile generation for Node.js ==="
# Test generating lockfile for multiple platforms with current Node version
assert_contains "mise lock nodejs --platform linux-x64,macos-arm64,windows-x64" "Targeting 3 platform(s): linux-x64, macos-arm64, windows-x64"
assert_contains "mise lock nodejs --platform linux-x64,macos-arm64,windows-x64" "Lockfile updated at"

# Verify the lockfile contains platform-specific data for all 3 platforms
assert "test -f mise.lock" ""
assert_contains "cat mise.lock" "linux-x64"
assert_contains "cat mise.lock" "macos-arm64"
assert_contains "cat mise.lock" "windows-x64"

# Verify URLs are platform-specific for Node.js (uses official Node.js mirrors)
assert_contains "cat mise.lock" "nodejs.org/dist"
assert_contains "cat mise.lock" "linux-x64.tar.gz"
assert_contains "cat mise.lock" "darwin-arm64.tar.gz"
assert_contains "cat mise.lock" "win-x64.zip"

# Verify basic metadata is present
assert_contains "cat mise.lock" 'backend = "core:node"'
assert_contains "cat mise.lock" 'version = "20.1.0"'

echo "=== Testing platform-specific URL patterns ==="
# Verify each platform has the correct URL pattern
output=$(cat mise.lock)
assert_contains "echo '$output'" "node-v20.1.0-linux-x64.tar.gz"
assert_contains "echo '$output'" "node-v20.1.0-darwin-arm64.tar.gz"
assert_contains "echo '$output'" "node-v20.1.0-win-x64.zip"

echo "=== Testing cross-platform consistency ==="
# Test that force regeneration maintains consistency
assert_contains "mise lock nodejs --platform linux-x64,macos-arm64,windows-x64 --force" "Lockfile updated at"
# Should still have all 3 platforms
assert_contains "cat mise.lock" "linux-x64"
assert_contains "cat mise.lock" "macos-arm64"
assert_contains "cat mise.lock" "windows-x64"

mise use --rm node

# MISE_LEGACY_VERSION_FILE env var
assert_contains "MISE_LEGACY_VERSION_FILE=1 mise current node" "$latest"
assert_not_contains "MISE_LEGACY_VERSION_FILE=0 mise current node" "$latest"
